name: Export EDBP Plugin Data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Fetch and Process Data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TOPIC_NAME: "edbp-plugin"
        run: |
          echo "--- Searching for repositories with topic: $TOPIC_NAME ---"
          
          # 1. 検索時は 'fullName' を使用してリストを取得
          REPOS=$(gh search repos --topic "$TOPIC_NAME" --json fullName -q '.[].fullName')

          if [ -z "$REPOS" ]; then
            echo "::error::No repositories found with topic: $TOPIC_NAME"
            exit 1
          fi

          echo "[]" > edbp_data.json

          for REPO in $REPOS; do
            echo "Processing: $REPO"
            OWNER=${REPO%/*}
            NAME=${REPO#*/}

            # 2. GraphQLクエリ (ここでは 'nameWithOwner' を使用)
            # ブランチ(refs)、最新コミット、リリース情報を取得
            QUERY='
            query($owner:String!, $name:String!) {
              repository(owner:$owner, name:$name) {
                nameWithOwner
                url
                description
                stargazerCount
                refs(refPrefix: "refs/heads/", first: 50) {
                  nodes {
                    name
                    target {
                      ... on Commit {
                        oid
                        message
                        committedDate
                        author {
                          name
                          email
                        }
                      }
                    }
                  }
                }
                releases(first: 50, orderBy: {field: CREATED_AT, direction: DESC}) {
                  nodes {
                    tagName
                    name
                    publishedAt
                  }
                }
              }
            }'

            # API実行結果を抽出して一時保存
            gh api graphql -f query="$QUERY" -f owner="$OWNER" -f name="$NAME" \
              --jq '.data.repository' > single_repo.json

            # 3. JSONが正しく取得できていればマージ
            if [ -s single_repo.json ] && [ "$(cat single_repo.json)" != "null" ]; then
              jq ". += [$(cat single_repo.json)]" edbp_data.json > temp.json && mv temp.json edbp_data.json
            else
              echo "Warning: Could not fetch details for $REPO"
            fi
          done

          echo "--- Data collection complete ---"

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add edbp_data.json
          # 差分がある場合のみコミット
          if ! git diff --cached --exit-code; then
            git commit -m "Update edbp-plugin info: $(date +'%Y-%m-%d')"
            git push
          else
            echo "No changes to commit"
          fi
