name: Export EDBP Plugin Data with Manifest

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Fetch and Process Data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TOPIC_NAME: "edbp-plugin"
        run: |
          echo "--- Searching for repositories with topic: $TOPIC_NAME ---"
          
          # 1. リポジトリリストの取得
          REPOS=$(gh search repos --topic "$TOPIC_NAME" --json fullName -q '.[].fullName')

          if [ -z "$REPOS" ]; then
            echo "::error::No repositories found with topic: $TOPIC_NAME"
            exit 1
          fi

          echo "[]" > edbp_data.json

          for REPO in $REPOS; do
            echo "Processing: $REPO"
            OWNER=${REPO%/*}
            NAME=${REPO#*/}

            # 2. GraphQLクエリ (manifest.json の取得を追加)
            # HEAD:manifest.json は、デフォルトブランチのルートにある manifest.json を指します
            QUERY='
            query($owner:String!, $name:String!) {
              repository(owner:$owner, name:$name) {
                nameWithOwner
                url
                description
                stargazerCount
                forkCount
                manifestFile: object(expression: "HEAD:manifest.json") {
                  ... on Blob {
                    text
                  }
                }
                refs(refPrefix: "refs/heads/", first: 10) {
                  nodes {
                    name
                    target {
                      ... on Commit {
                        oid
                        message
                        committedDate
                      }
                    }
                  }
                }
                releases(first: 10, orderBy: {field: CREATED_AT, direction: DESC}) {
                  nodes {
                    tagName
                    name
                    publishedAt
                  }
                }
              }
            }'

            # API実行
            gh api graphql -f query="$QUERY" -f owner="$OWNER" -f name="$NAME" \
              --jq '.data.repository' > single_repo.json

            # 3. manifest.json (テキスト) を JSONオブジェクトに変換してマージ
            # textフィールドに入っている文字列を jq の fromjson でパースします
            if [ -s single_repo.json ] && [ "$(cat single_repo.json)" != "null" ]; then
              jq 'if .manifestFile and .manifestFile.text then .manifest = (.manifestFile.text | fromjson) else .manifest = null end | del(.manifestFile)' \
              single_repo.json > processed_repo.json
              
              jq ". += [$(cat processed_repo.json)]" edbp_data.json > temp.json && mv temp.json edbp_data.json
            fi
          done

          echo "--- Data collection complete ---"

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add edbp_data.json
          if ! git diff --cached --exit-code; then
            git commit -m "Update edbp-plugin info with manifest: $(date +'%Y-%m-%d')"
            git push
          fi
